<div class="chat-box">
  <div class="chat-box__window-header">
    <div class="chat-box__window-user">
      <img
        [src]="
          currentChatUser()?.partner?.image
            ? currentChatUser()!.partner!.image
            : 'assets/defaults/default-user.png'
        "
        alt="User"
        class="chat-box__window-avatar"
      />
      <span class="chat-box__window-name">{{
        currentUser()?.partner?.name || 'User'
      }}</span>
    </div>

    <app-button size="small" (clickEvent)="videoCall()">Vide Call</app-button>

    @if (isMobileScreen) {
      <app-button size="small" (clickEvent)="closeChat.emit()">Back</app-button>
    }
  </div>

  @if (isIncomingCall()) {
    <div class="chat-box__video-call">
      <div class="user-text">
        <p>INCOMING VIDEO CALL...</p>
      </div>
      <div class="actions">
        <app-button variant="success"
          ><mat-icon class="material-icons-outlined">videocam</mat-icon>
          &nbsp;Accept</app-button
        >
        <app-button variant="danger"
          ><mat-icon class="material-icons-outlined">call_end</mat-icon>
          &nbsp;Reject</app-button
        >
      </div>
    </div>
  }

  <div class="chat-box__messages">
    @if (messages().length > 0) {
      @for (userMesage of messages(); track $index) {
        <div
          class="chat-box__message"
          [ngClass]="{
            'chat-box__message--incoming':
              userMesage.senderId !== loggedInUser()?.id,
          }"
        >
          <!-- check type and if hte image type show image else show the txt  -->
          @if (userMesage.type === messageType.IMAGE) {
            <div
              class="image-message"
              (click)="openImagePreview(userMesage.imageUrl)"
              role="button"
              tabindex="0"
            >
              <img [src]="userMesage.imageUrl" alt="" loading="lazy" />
            </div>
          } @else {
            <p class="chat-box__message-text">{{ userMesage.text }}</p>
          }

          @if (userMesage.senderId === loggedInUser()?.id) {
            <div class="chat-box__message-status">
              <small>
                {{ userMesage.time | date: 'hh:mm a' }}&nbsp;
                {{ userMesage.isRead ? 'seen' : 'sent' }}
              </small>
            </div>
          }
        </div>
      } @empty {
        <p class="empty-text">Start Messaging</p>
      }
    }
  </div>

  <div class="chat-box__input">
    <label class="chat-box__image-upload">
      <input
        type="file"
        accept="image/*"
        (change)="onImageSelect($event)"
        hidden
      />

      <span class="chat-box__image-icon"
        ><mat-icon class="material-icons-outlined"
          >add_photo_alternate</mat-icon
        ></span
      >
    </label>

    <input
      type="text"
      placeholder="Type a message..."
      class="chat-box__input-field"
      [(ngModel)]="message"
      (keydown.enter)="onEnter()"
    />
    <app-button (clickEvent)="sendMessage()">Send</app-button>
  </div>
</div>
